<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CANIG — Screen Sound Recorder</title>
  <link rel="stylesheet" href="index.css" />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo">CANIG</div>
        <div>
          <h1>CANIG</h1>
          <p class="tag">Capture & Save — Screen / System Audio Only</p>
        </div>
        <div class="brand-right">v1.0</div>
      </div>

      <p class="lead">
        CANIG lets you record the <strong>sound</strong> from your screen or tab.
        Click <strong>Start Recording</strong>, then select a window or tab and enable
        <strong>“Share audio”</strong> when prompted.
      </p>

      <div class="controls">
        <button id="startBtn" class="primary">Start Recording</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="playBtn" disabled>Play</button>
        <button id="downloadBtn" disabled>Download</button>
        <button id="muteBtn" disabled>Mute Preview</button>
      </div>

      <div class="meta">
        <div class="chip" id="statusChip">Idle</div>
        <div class="chip">Format: <span id="formatText">webm/opus</span></div>
        <div class="chip">Size: <span id="sizeText">0 KB</span></div>
        <div class="chip">Duration: <span id="duration">00:00</span></div>
      </div>

      <audio id="playback" controls></audio>

      <p class="note">
        Note: Your recording never leaves your device — everything is processed locally.
        Use the latest Chrome or Edge browser for best results.
      </p>

      <div class="footer">
        <div class="danger">Local only — no uploads</div>
        <div class="timer" id="recTimer">00:00</div>
      </div>
    </div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const playBtn = document.getElementById('playBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const muteBtn = document.getElementById('muteBtn');
    const playback = document.getElementById('playback');
    const statusChip = document.getElementById('statusChip');
    const sizeText = document.getElementById('sizeText');
    const durationText = document.getElementById('duration');
    const recTimer = document.getElementById('recTimer');
    const formatText = document.getElementById('formatText');

    let mediaRecorder = null;
    let recordedChunks = [];
    let capturedStream = null;
    let recordingStart = null;
    let timerInterval = null;
    let audioURL = null;

    function setStatus(txt, color) {
      statusChip.textContent = txt;
      statusChip.style.color = color || '';
    }

    function formatTime(s) {
      const mm = String(Math.floor(s / 60)).padStart(2, '0');
      const ss = String(Math.floor(s % 60)).padStart(2, '0');
      return `${mm}:${ss}`;
    }

    function updateTimer() {
      if (!recordingStart) return;
      const elapsed = (Date.now() - recordingStart) / 1000;
      recTimer.textContent = formatTime(elapsed);
      durationText.textContent = formatTime(elapsed);
    }

    startBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        alert('Your browser does not support screen capture. Use Chrome or Edge.');
        return;
      }

      startBtn.disabled = true;
      setStatus('Requesting screen share...', '#ffda79');

      try {
        const constraints = { video: true, audio: true };
        capturedStream = await navigator.mediaDevices.getDisplayMedia(constraints);

        const audioTracks = capturedStream.getAudioTracks();
        if (!audioTracks.length) {
          setStatus('No audio track found in chosen source.', '#ff7b7b');
          startBtn.disabled = false;
          capturedStream.getTracks().forEach(t => t.stop());
          return;
        }

        const audioOnlyStream = new MediaStream(audioTracks);
        const mime =
          MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
            ? 'audio/webm;codecs=opus'
            : 'audio/webm';

        recordedChunks = [];
        mediaRecorder = new MediaRecorder(audioOnlyStream, { mimeType: mime });
        formatText.textContent = mime;

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
          const total = recordedChunks.reduce((s, b) => s + b.size, 0) / 1024;
          sizeText.textContent = `${total.toFixed(1)} KB`;
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: mime });
          if (audioURL) URL.revokeObjectURL(audioURL);
          audioURL = URL.createObjectURL(blob);
          playback.src = audioURL;

          playBtn.disabled = false;
          downloadBtn.disabled = false;
          muteBtn.disabled = false;
          setStatus('Recording stopped — ready to play/download', '#8ef0b1');

          if (capturedStream) capturedStream.getTracks().forEach(t => t.stop());
          clearInterval(timerInterval);
        };

        mediaRecorder.start(250);
        setStatus('Recording...', '#8ef0b1');
        stopBtn.disabled = false;
        startBtn.disabled = true;
        playBtn.disabled = true;
        downloadBtn.disabled = true;
        muteBtn.disabled = true;

        recordingStart = Date.now();
        recTimer.textContent = '00:00';
        timerInterval = setInterval(updateTimer, 500);
      } catch (err) {
        console.error(err);
        setStatus('Capture cancelled or failed.', '#ff9b9b');
        startBtn.disabled = false;
        if (capturedStream) capturedStream.getTracks().forEach(t => t.stop());
      }
    });

    stopBtn.addEventListener('click', () => {
      if (!mediaRecorder) return;
      setStatus('Stopping...', '#ffd36b');
      stopBtn.disabled = true;
      startBtn.disabled = false;
      mediaRecorder.stop();
    });

    playBtn.addEventListener('click', () => {
      if (playback.src) playback.play();
    });

    downloadBtn.addEventListener('click', () => {
      const blob = new Blob(recordedChunks, { type: 'audio/webm' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `CANIG-audio-${Date.now()}.webm`;
      a.click();
    });

    muteBtn.addEventListener('click', () => {
      playback.muted = !playback.muted;
      muteBtn.textContent = playback.muted ? 'Unmute Preview' : 'Mute Preview';
    });
  </script>
</body>
</html>
